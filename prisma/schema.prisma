generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int       @id @default(autoincrement())
  firstName String
  lastName  String
  email     String    @unique
  password  String
  phone     String?
  address   String?
  role      Role
  createdAt DateTime  @default(now())
  demandes  Demande[] // 1 user → N demandes
  dossiersEtude DossierEtude[] // ✅ relation inverse
  dossierExecution DossierExecution[]
  visites          Visite[]          // ← NEW : visites effectuées par cet utilisateur (responsable)
}

model Demande {
  id          Int         @id @default(autoincrement())
  titre       String
  ville       String
  adresse     String
  type        TypeDemande
  description String
  status      StatusDemande @default(EN_ATTENTE)
  remarques   String?
  createdAt   DateTime    @default(now())
  clientId    Int
  client      User        @relation(fields: [clientId], references: [id])
  documents   Document[]  // 1 demande → N documents
  
  dossierEtude DossierEtude? // ✅ Relation 1:1 inverse
  dossierExecution DossierExecution?
}

model Document {
  id         Int      @id @default(autoincrement())
  filename   String
  path       String   // ex: /uploads/file.pdf
  uploadedAt DateTime @default(now())
  demandeId  Int
  demande    Demande  @relation(fields: [demandeId], references: [id])
  dossierEtudeId Int?          // ← clé étrangère facultative
  dossierEtude   DossierEtude? @relation(fields: [dossierEtudeId], references: [id])
  dossierExecutionId Int?          // ← clé étrangère facultative
  dossierExecution   DossierExecution? @relation(fields: [dossierExecutionId], references: [id])
  label String?

    // ✅ Relation 1:1 avec Visite, seulement définie ici
  visite   Visite?   @relation("VisiteDocument")
}

model DossierEtude {
  id         Int              @id @default(autoincrement())
  createdAt  DateTime         @default(now())
  remarques  String?
  status     StatusDossierEtude @default(EN_COURS)
  clientId   Int
  demandeId  Int @unique

  client     User             @relation(fields: [clientId], references: [id])
  demande    Demande          @relation(fields: [demandeId], references: [id])
  documents  Document[]       // 1 dossier → N documents
}
model DossierExecution {
  id         Int              @id @default(autoincrement())
  createdAt  DateTime         @default(now())
  remarques  String?
  status     StatusDossierEtude @default(EN_COURS)
  clientId   Int
  demandeId  Int @unique

  client     User             @relation(fields: [clientId], references: [id])
  demande    Demande          @relation(fields: [demandeId], references: [id])
  documents  Document[]       // 1 dossier → N documents
  // ✅ Ajout : un dossier d’exécution peut avoir plusieurs visites
  visites    Visite[]
}

model Visite {
  id                  Int               @id @default(autoincrement())
  date                DateTime
  remarques           String?
  createdAt           DateTime          @default(now())

  // Responsable qui a effectué la visite
  responsableId       Int
  responsable         User              @relation(fields: [responsableId], references: [id])

  // Lien vers le dossier d'exécution
  dossierExecutionId  Int
  dossierExecution    DossierExecution  @relation(fields: [dossierExecutionId], references: [id])
  typeVisite String?
  // Document associé (optionnel). @unique pour garantir 1 doc par visite.
  documentId          Int?              @unique
  document            Document?         @relation("VisiteDocument", fields: [documentId], references: [id])
}

enum StatusDossierEtude {
  EN_COURS
  ACCEPTEE
  A_CORRIGER
}


enum Role {
  CLIENT
  RESPONSABLE_AEP
  RESPONSABLE_ASSEU
  DIRECTEUR
}

enum TypeDemande {
  AEP
  ASSEU
  LES_DEUX
}

enum StatusDemande {
  EN_ATTENTE
  EN_ETUDE
  ACCEPTEE
  A_CORRIGER
}



